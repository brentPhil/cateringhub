# RLS Policy Audit and Cleanup

**Migration:** 20251101000008_rls_policy_audit.md  
**Date:** November 1, 2025  
**Task:** Phase 2 - RLS Policies & Security - Audit existing policies  
**Status:** ‚úÖ AUDIT COMPLETED

---

## Executive Summary

Audited all existing RLS policies across core tables (bookings, provider_members, service_locations, teams, shifts, providers) to identify redundant, conflicting, or overly permissive policies before implementing team-based assignment model.

**Key Findings:**
- ‚úÖ Most policies are well-structured and use helper functions correctly
- ‚ö†Ô∏è **CRITICAL**: Bookings policies use individual assignment model (`assigned_to`) - will conflict with team-based model
- ‚ö†Ô∏è Service locations and providers policies have redundant logic checking both `provider_members` AND `providers.user_id`
- ‚úÖ Shifts policies are provider-scoped and will work with team model
- ‚úÖ Provider_members policies are clean and use proper helper functions

---

## Detailed Audit by Table

### 1. BOOKINGS Table (4 policies) ‚ö†Ô∏è NEEDS UPDATE

#### Current Policies:

**SELECT: "Provider members can view bookings"**
```sql
USING (
  is_provider_member(provider_id, auth.uid(), 'manager'::provider_role) OR
  (is_provider_member(provider_id, auth.uid(), 'staff'::provider_role) AND assigned_to = auth.uid()) OR
  customer_id = auth.uid()
)
```
**Issues:**
- ‚ùå Uses `assigned_to` (individual assignment) - conflicts with team-based model
- ‚ùå Staff can only see bookings assigned to them individually
- ‚úÖ Managers can see all bookings (good)
- ‚úÖ Customers can see their own bookings (good)

**Recommendation:** üîÑ **REPLACE** with team-based policy using `is_team_member_for_booking()`

---

**INSERT: "Users can create bookings"**
```sql
WITH CHECK (
  (source = 'auto' AND customer_id = auth.uid()) OR
  (source = 'manual' AND is_provider_member(provider_id, auth.uid(), 'staff'::provider_role))
)
```
**Issues:**
- ‚úÖ Correctly separates auto (customer) vs manual (provider) bookings
- ‚úÖ Uses proper role check for manual bookings

**Recommendation:** ‚úÖ **KEEP** - no changes needed

---

**UPDATE: "Provider members can update bookings"**
```sql
USING (
  is_provider_member(provider_id, auth.uid(), 'manager'::provider_role) OR
  (is_provider_member(provider_id, auth.uid(), 'staff'::provider_role) AND assigned_to = auth.uid()) OR
  (customer_id = auth.uid() AND status = 'pending')
)
WITH CHECK (same as USING)
```
**Issues:**
- ‚ùå Uses `assigned_to` (individual assignment) - conflicts with team-based model
- ‚ùå Staff can only update bookings assigned to them individually
- ‚úÖ Managers can update all bookings (good)
- ‚úÖ Customers can update pending bookings (good)

**Recommendation:** üîÑ **REPLACE** with team-based policy

---

**DELETE: "Admins can delete bookings"**
```sql
USING (
  is_provider_member(provider_id, auth.uid(), 'admin'::provider_role) OR
  (customer_id = auth.uid() AND status = 'pending')
)
```
**Issues:**
- ‚úÖ Correctly restricts deletion to admins+ only
- ‚úÖ Allows customers to cancel pending bookings

**Recommendation:** ‚úÖ **KEEP** - no changes needed

---

### 2. PROVIDER_MEMBERS Table (4 policies) ‚úÖ CLEAN

**SELECT: "Members can view their provider members"**
```sql
USING (provider_id IN (SELECT provider_id FROM get_user_provider_ids(auth.uid())))
```
**Issues:**
- ‚úÖ Uses helper function correctly
- ‚úÖ Allows members to see other members in their provider

**Recommendation:** ‚úÖ **KEEP** - no changes needed

---

**INSERT: "Admins and owners can create members"**
```sql
WITH CHECK (is_provider_admin(provider_id, auth.uid()))
```
**Issues:**
- ‚úÖ Correctly restricts to admin/owner roles

**Recommendation:** ‚úÖ **KEEP** - no changes needed

---

**UPDATE: "Admins and owners can update members"**
```sql
USING (is_provider_admin(provider_id, auth.uid()))
WITH CHECK (is_provider_admin(provider_id, auth.uid()))
```
**Issues:**
- ‚úÖ Correctly restricts to admin/owner roles

**Recommendation:** ‚úÖ **KEEP** - no changes needed

---

**DELETE: "Admins and owners can remove members"**
```sql
USING (is_provider_admin(provider_id, auth.uid()))
```
**Issues:**
- ‚úÖ Correctly restricts to admin/owner roles

**Recommendation:** ‚úÖ **KEEP** - no changes needed

---

### 3. SERVICE_LOCATIONS Table (4 policies) ‚ö†Ô∏è REDUNDANT LOGIC

All 4 policies (SELECT, INSERT, UPDATE, DELETE) have the same pattern:

**Example: "Team members can view service locations"**
```sql
USING (
  provider_id IN (SELECT provider_id FROM provider_members WHERE user_id = auth.uid() AND status = 'active') OR
  provider_id IN (SELECT id FROM providers WHERE user_id = auth.uid())
)
```

**Issues:**
- ‚ö†Ô∏è **REDUNDANT**: Checks both `provider_members` AND `providers.user_id`
- ‚ö†Ô∏è The `providers.user_id` check is legacy from before provider_members existed
- ‚ö†Ô∏è All providers should have a corresponding provider_member record (owner role)
- ‚úÖ Correctly scoped to provider membership

**Recommendation:** üîÑ **SIMPLIFY** - Remove redundant `providers.user_id` check, use `is_provider_member()` helper

---

### 4. PROVIDERS Table (4 policies) ‚ö†Ô∏è REDUNDANT LOGIC

**SELECT: "Team members can view provider profile"**
```sql
USING (
  id IN (SELECT provider_id FROM provider_members WHERE user_id = auth.uid() AND status = 'active') OR
  user_id = auth.uid()
)
```
**Issues:**
- ‚ö†Ô∏è **REDUNDANT**: Same issue as service_locations
- ‚ö†Ô∏è `user_id = auth.uid()` is legacy check

**Recommendation:** üîÑ **SIMPLIFY** - Use `is_provider_member()` helper

---

**INSERT: "Authenticated users can create providers"**
```sql
WITH CHECK (auth.uid() = user_id)
```
**Issues:**
- ‚úÖ Correctly ensures user creates provider for themselves

**Recommendation:** ‚úÖ **KEEP** - no changes needed

---

**UPDATE: "Team members can update provider profile"**
```sql
USING (
  id IN (SELECT provider_id FROM provider_members WHERE user_id = auth.uid() AND status = 'active' AND role IN ('owner', 'admin', 'manager')) OR
  user_id = auth.uid()
)
WITH CHECK (same as USING)
```
**Issues:**
- ‚ö†Ô∏è **REDUNDANT**: Same issue as above
- ‚ö†Ô∏è Hardcodes role array instead of using `is_provider_member()` with min_role

**Recommendation:** üîÑ **SIMPLIFY** - Use `is_provider_member(provider_id, auth.uid(), 'manager')`

---

**DELETE: "Owners can delete providers"**
```sql
USING (
  id IN (SELECT provider_id FROM provider_members WHERE user_id = auth.uid() AND status = 'active' AND role = 'owner') OR
  user_id = auth.uid()
)
```
**Issues:**
- ‚ö†Ô∏è **REDUNDANT**: Same issue as above
- ‚úÖ Correctly restricts to owner role only

**Recommendation:** üîÑ **SIMPLIFY** - Use `is_provider_member(provider_id, auth.uid(), 'owner')`

---

### 5. SHIFTS Table (4 policies) ‚úÖ MOSTLY CLEAN

All policies follow the same pattern of checking provider membership via booking:

**Example: "Provider members can view shifts"**
```sql
USING (
  EXISTS (
    SELECT 1 FROM provider_members pm
    JOIN bookings b ON b.provider_id = pm.provider_id
    WHERE b.id = shifts.booking_id
      AND pm.user_id = auth.uid()
      AND pm.status = 'active'
  )
)
```

**Issues:**
- ‚úÖ Correctly scoped to provider membership
- ‚úÖ Works with team-based model (no dependency on `assigned_to`)
- ‚ö†Ô∏è Could be simplified with a helper function like `is_provider_member_for_booking()`

**Recommendation:** ‚úÖ **KEEP** - works with team model, optional optimization later

---

## Summary of Actions Required

### üî¥ CRITICAL - Must Fix for Team-Based Model

1. **Bookings SELECT policy** - Replace `assigned_to` check with team-based logic
2. **Bookings UPDATE policy** - Replace `assigned_to` check with team-based logic

### üü° RECOMMENDED - Simplify and Standardize

3. **Service_locations policies (4)** - Remove redundant `providers.user_id` checks
4. **Providers policies (3)** - Remove redundant `user_id` checks, use helper functions

### üü¢ OPTIONAL - Future Optimization

5. **Shifts policies** - Consider creating `is_provider_member_for_booking()` helper
6. **Create team-based helper functions** - Already done in migration 20251101000006

---

## Migration Plan

### Phase 1: Create Cleanup Migration (20251101000009)
- Drop and recreate bookings policies with team-based logic
- Drop and recreate service_locations policies with simplified logic
- Drop and recreate providers policies with helper functions

### Phase 2: Test and Validate
- Verify all policies work correctly
- Test team-based access control
- Ensure backwards compatibility during migration period

### Phase 3: Update Application Code
- Update frontend to use team-based queries
- Remove references to `assigned_to` field
- Implement dual-write period for migration

---

## Helper Functions Available

‚úÖ **Existing:**
- `is_provider_member(provider_id, user_id, min_role)` - Check role hierarchy
- `is_provider_admin(provider_id, user_id)` - Check admin/owner
- `get_user_provider_ids(user_id)` - Get all provider IDs for user

‚úÖ **New (from migration 20251101000006):**
- `get_team_for_booking(booking_id)` - Get team for booking
- `is_team_member_for_booking(booking_id, user_id)` - Check team membership for booking
- `get_user_teams(user_id, provider_id)` - Get user's teams
- `is_team_member(team_id, user_id)` - Check team membership
- `get_team_capacity_info(team_id, event_date)` - Get capacity stats
- `can_team_accept_booking(team_id, event_date)` - Check capacity

---

## Conclusion

**Total Policies Audited:** 20  
**Policies to Replace:** 2 (bookings SELECT, UPDATE)  
**Policies to Simplify:** 7 (service_locations x4, providers x3)  
**Policies to Keep:** 11 (provider_members x4, bookings x2, shifts x4, providers x1)

Next step: Create migration 20251101000009 to implement the cleanup.

